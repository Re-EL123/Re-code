<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Re-Code | Re-EL's Advanced Coding AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Puter AI -->
<script src="https://js.puter.com/v2/"></script>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Monaco Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/editor/editor.main.css" />
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,system-ui,sans-serif;background:#0a0e1a;color:#f1f5f9;overflow-x:hidden}
.app{max-width:1800px;margin:auto;padding:20px;position:relative}
.layout{display:grid;grid-template-columns:280px 1fr;gap:20px}

/* Header */
header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);padding:20px 28px;border-radius:20px;margin-bottom:4px;border:1px solid rgba(110,243,197,.2);box-shadow:0 8px 32px rgba(0,0,0,.3);animation:slideDown 0.6s ease}
.brand{display:flex;align-items:center;gap:12px;font-size:1.6rem;font-weight:900;background:linear-gradient(135deg,#6ef3c5,#4ade80);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.brand i{color:#6ef3c5;animation:pulse 2s ease infinite}

/* Credit System */
.credit-section{display:flex;align-items:center;gap:16px}
.credit-display{display:flex;align-items:center;gap:10px;padding:10px 20px;border-radius:14px;background:rgba(110,243,197,.1);border:2px solid rgba(110,243,197,.3);font-weight:700;font-size:1rem;transition:all 0.3s}
.credit-display.unlimited{background:rgba(110,243,197,.15);border-color:rgba(110,243,197,.5);box-shadow:0 0 20px rgba(110,243,197,.3)}
.credit-bar{width:120px;height:8px;background:#020617;border-radius:10px;overflow:hidden;border:1px solid #1e293b;display:none}

/* Sidebar - File Explorer */
.sidebar{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:fadeIn 0.6s ease;max-height:calc(100vh - 140px);overflow-y:auto}
.sidebar-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.1)}
.sidebar-title{display:flex;align-items:center;gap:8px;font-weight:700;color:#6ef3c5;font-size:1rem}
.file-list{display:flex;flex-direction:column;gap:8px}
.file-item{padding:12px 14px;background:rgba(2,6,23,.6);border:1px solid #1e293b;border-radius:12px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:space-between;gap:8px}
.file-item:hover{border-color:#6ef3c5;background:rgba(110,243,197,.05);transform:translateX(4px)}
.file-item.active{border-color:#6ef3c5;background:rgba(110,243,197,.1)}
.file-info{flex:1;min-width:0}
.file-name{font-weight:600;font-size:0.9rem;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-meta{font-size:0.75rem;color:#64748b;margin-top:2px}
.file-actions{display:flex;gap:4px}
.file-btn{padding:6px;background:transparent;border:none;cursor:pointer;color:#94a3b8;border-radius:6px;transition:all 0.2s}
.file-btn:hover{background:rgba(110,243,197,.2);color:#6ef3c5}
.empty-state{text-align:center;padding:40px 20px;color:#64748b;font-size:0.9rem}
.empty-state i{font-size:3rem;margin-bottom:12px;opacity:0.3}

/* Main Content */
.main-content{display:flex;flex-direction:column;gap:20px}
.main-panel{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:fadeIn 0.6s ease}
.prompt-section{position:relative}
.prompt-label{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-weight:600;color:#6ef3c5;font-size:1rem}
textarea{width:100%;min-height:120px;background:rgba(2,6,23,.8);color:#e5e7eb;border-radius:16px;border:2px solid #1e293b;padding:16px;resize:vertical;font-size:0.95rem;line-height:1.6;transition:all 0.3s;font-family:inherit}
textarea:focus{outline:none;border-color:#6ef3c5;box-shadow:0 0 0 3px rgba(110,243,197,.1)}
textarea::placeholder{color:#64748b}

/* Filename Input */
.filename-section{margin-top:12px;display:flex;gap:8px;align-items:center}
.filename-input{flex:1;background:rgba(2,6,23,.8);color:#e5e7eb;border-radius:12px;border:2px solid #1e293b;padding:10px 14px;font-size:0.9rem;transition:all 0.3s}
.filename-input:focus{outline:none;border-color:#6ef3c5;box-shadow:0 0 0 3px rgba(110,243,197,.1)}
.auto-name-btn{padding:10px 16px;background:rgba(110,243,197,.1);border:1px solid rgba(110,243,197,.3);border-radius:10px;color:#6ef3c5;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.3s}
.auto-name-btn:hover{background:rgba(110,243,197,.2);transform:scale(1.02)}

/* Token Estimation */
.token-estimate{display:flex;align-items:center;gap:12px;margin-top:12px;padding:12px 16px;background:rgba(110,243,197,.05);border-radius:12px;border:1px solid rgba(110,243,197,.15);font-size:0.9rem;color:#94a3b8}
.token-estimate i{color:#6ef3c5}
.token-cost{font-weight:700;color:#6ef3c5}

/* Actions */
.actions{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
button{padding:14px 24px;border:none;border-radius:14px;font-weight:700;cursor:pointer;font-size:0.95rem;display:flex;align-items:center;gap:8px;transition:all 0.3s;position:relative;overflow:hidden}
button:before{content:"";position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.2);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s}
button:hover:before{width:300px;height:300px}
button.primary{background:linear-gradient(135deg,#6ef3c5,#4ade80);color:#000;box-shadow:0 4px 16px rgba(110,243,197,.3)}
button.primary:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(110,243,197,.4)}
button.secondary{background:#020617;color:#e5e7eb;border:2px solid #1e293b}
button.secondary:hover{border-color:#6ef3c5;background:#0a1628}
button:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
button i{z-index:1}
button span{z-index:1}

/* Progress Bar */
.progress-container{margin-top:16px;display:none}
.progress-container.active{display:block;animation:fadeIn 0.3s}
.progress-bar{width:100%;height:6px;background:#020617;border-radius:10px;overflow:hidden;border:1px solid #1e293b}
.progress-fill{height:100%;background:linear-gradient(90deg,#6ef3c5,#4ade80,#6ef3c5);background-size:200% 100%;animation:progressShimmer 2s linear infinite;transition:width 0.3s}
.progress-text{margin-top:8px;font-size:0.85rem;color:#94a3b8;text-align:center}

/* Auto-continue indicator */
.auto-continue-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(251,191,36,.15);padding:4px 12px;border-radius:8px;font-size:0.8rem;color:#fbbf24;font-weight:600;animation:badgePulse 2s ease infinite}

/* Editor Container */
.editor-container{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:fadeIn 0.8s ease}
.editor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.editor-title{display:flex;align-items:center;gap:8px;font-weight:700;color:#6ef3c5;font-size:1.1rem}
.editor-actions{display:flex;gap:8px}
.icon-btn{padding:10px;border:none;background:rgba(110,243,197,.1);border-radius:10px;cursor:pointer;transition:all 0.3s;color:#6ef3c5;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{background:rgba(110,243,197,.2);transform:scale(1.05)}
.icon-btn:disabled{opacity:.5;cursor:not-allowed}
#editor{height:500px;border-radius:16px;border:2px solid #1e293b;overflow:hidden;box-shadow:inset 0 2px 8px rgba(0,0,0,.3)}

/* Stats */
.stats{display:flex;gap:24px;margin-top:16px;padding:16px;background:rgba(2,6,23,.6);border-radius:12px;border:1px solid #1e293b;flex-wrap:wrap}
.stat-item{display:flex;align-items:center;gap:8px;font-size:0.9rem;color:#94a3b8}
.stat-item i{color:#6ef3c5}
.stat-value{font-weight:700;color:#e5e7eb}

/* Toast System */
.toast{position:fixed;bottom:24px;right:24px;background:rgba(2,6,23,.95);backdrop-filter:blur(20px);border:2px solid;padding:16px 24px;border-radius:16px;display:flex;align-items:center;gap:12px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideIn 0.3s ease;z-index:1000;max-width:400px}
.toast.success{border-color:#4ade80;color:#4ade80}
.toast.error{border-color:#ef4444;color:#ef4444}
.toast.warning{border-color:#fbbf24;color:#fbbf24}
.toast.info{border-color:#6ef3c5;color:#6ef3c5}
.toast i{flex-shrink:0}

/* Alert Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:2000;animation:fadeIn 0.3s}
.modal{background:rgba(2,6,23,.98);border:2px solid;border-radius:20px;padding:32px;max-width:500px;width:90%;box-shadow:0 16px 64px rgba(0,0,0,.7);animation:scaleIn 0.3s ease}
.modal.warning{border-color:#fbbf24}
.modal.danger{border-color:#ef4444}
.modal-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.modal-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px}
.modal.warning .modal-icon{background:rgba(251,191,36,.2);color:#fbbf24}
.modal.danger .modal-icon{background:rgba(239,68,68,.2);color:#ef4444}
.modal-title{font-size:1.4rem;font-weight:800}
.modal-body{color:#94a3b8;line-height:1.6;margin-bottom:24px}
.modal-actions{display:flex;gap:12px}

/* Animations */
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes badgePulse{0%,100%{opacity:1}50%{opacity:.7}}
@keyframes warningPulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.4)}50%{box-shadow:0 0 0 8px rgba(251,191,36,0)}}
@keyframes dangerPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
@keyframes progressShimmer{0%{background-position:0% 0}100%{background-position:200% 0}}

/* Responsive */
@media(max-width:1024px){
  .layout{grid-template-columns:1fr}
  .sidebar{max-height:300px}
}
@media(max-width:768px){
  header{flex-direction:column;gap:16px;text-align:center}
  .actions{flex-direction:column}
  button{width:100%;justify-content:center}
  .stats{flex-direction:column;gap:12px}
  #editor{height:400px}
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

// Storage Manager (uses in-memory)
const storage={
  data:{files:[],activeFileId:null},
  save(){
    // In-memory storage (persists during browser session)
  },
  load(){
  }
};

function cleanCode(raw){
  return raw
    .replace(/```[\s\S]*?```/g,m=>m.replace(/```[\w]*\n?|```/g,""))
    .replace(/```/g,"")
    .replace(/I don't see any previous code.*$/s,'')
    .replace(/Could you please share.*$/s,'')
    .replace(/I'll continue.*$/s,'')
    .replace(/Let me continue.*$/s,'')
    .replace(/I need to see.*$/s,'')
    .replace(/Please provide.*$/s,'')
    .trim();
}

function detectLanguage(code){
  if(!code||code.length<10)return"plaintext";
  if(code.startsWith("<!DOCTYPE")||code.startsWith("<html")||/<html[\s>]/.test(code))return"html";
  if(/import React|from ['"]react['"]|const.*=.*React/.test(code))return"javascript";
  if(/def\s+\w+\(|import\s+\w+|print\(/.test(code))return"python";
  if(/System\.out\.print|public\s+class|public\s+static\s+void/.test(code))return"java";
  if(/#include\s*<|using namespace|std::/.test(code))return"cpp";
  if(/func\s+\w+\(|let\s+\w+:|var\s+\w+:/.test(code))return"swift";
  if(/fn\s+\w+\(|impl\s|pub\s+fn/.test(code))return"rust";
  if(/<?php|function\s+\w+\(.*\)\s*{/.test(code))return"php";
  if(/interface\s+\w+|type\s+\w+\s*=/.test(code))return"typescript";
  return"javascript";
}

function isCodeIncomplete(code,language){
  if(!code||code.length<50)return true;
  
  const trimmed=code.trim();
  const lastLine=trimmed.split('\n').pop().trim();
  
  // Check for incomplete patterns
  const incompletePatterns=[
    /[({[,]$/,
    /^\s*\/\//,
    /^\s*#/,
    /\bfunction\s+\w+\s*\(\s*$/,
    /\bif\s*\([^)]*$/,
    /\bfor\s*\([^)]*$/,
    /\bwhile\s*\([^)]*$/,
    /=>\s*$/,
    /:\s*$/,
    /\\\s*$/,
    /,\s*$/,
  ];
  
  for(const pattern of incompletePatterns){
    if(pattern.test(lastLine))return true;
  }
  
  // Language-specific incomplete checks
  if(language==="html"){
    const openTags=code.match(/<(\w+)[^>]*>/g)||[];
    const closeTags=code.match(/<\/(\w+)>/g)||[];
    if(openTags.length>closeTags.length+2)return true;
    if(!/<\/html>\s*$/.test(trimmed)&&code.includes('<html'))return true;
  }
  
  if(language==="javascript"||language==="typescript"){
    const openCurly=(code.match(/\{/g)||[]).length;
    const closeCurly=(code.match(/\}/g)||[]).length;
    const openParen=(code.match(/\(/g)||[]).length;
    const closeParen=(code.match(/\)/g)||[]).length;
    const openSquare=(code.match(/\[/g)||[]).length;
    const closeSquare=(code.match(/\]/g)||[]).length;
    
    if(Math.abs(openCurly-closeCurly)>1)return true;
    if(Math.abs(openParen-closeParen)>1)return true;
    if(Math.abs(openSquare-closeSquare)>1)return true;
  }
  
  if(language==="python"){
    const lines=code.split('\n');
    const lastNonEmpty=lines.filter(l=>l.trim()).pop();
    if(lastNonEmpty&&/:\s*$/.test(lastNonEmpty))return true;
    
    const lastIndent=(lastNonEmpty.match(/^\s*/)||[''])[0].length;
    if(lastIndent>8)return true;
  }
  
  const last200=code.slice(-200).toLowerCase();
  if(last200.includes('todo')||last200.includes('implement')||last200.includes('add more'))return true;
  
  return false;
}

function generateSmartFilename(prompt,code,lang){
  const keywords=prompt.toLowerCase().match(/\b(todo|calculator|game|chat|form|dashboard|api|app|component|website|page|tool|system)\b/g);
  const mainKeyword=keywords?keywords[0]:"code";
  
  const extensions={
    javascript:"js",typescript:"ts",html:"html",python:"py",
    java:"java",cpp:"cpp",rust:"rs",swift:"swift",php:"php"
  };
  const ext=extensions[lang]||"txt";
  
  let name=mainKeyword;
  if(lang==="javascript"||lang==="typescript"){
    const match=code.match(/(?:class|function|const)\s+(\w+)/);
    if(match)name=match[1].toLowerCase();
  }else if(lang==="python"){
    const match=code.match(/def\s+(\w+)|class\s+(\w+)/);
    if(match)name=(match[1]||match[2]).toLowerCase();
  }else if(lang==="java"){
    const match=code.match(/class\s+(\w+)/);
    if(match)name=match[1].toLowerCase();
  }
  
  return`${name}.${ext}`;
}

async function ensurePuterAuth(){
  try{
    const user=await puter.auth.whoami();
    return user;
  }catch{
    await puter.auth.signIn();
    return await puter.auth.whoami();
  }
}

function App(){
  const [prompt,setPrompt]=useState("");
  const [filename,setFilename]=useState("");
  const [loading,setLoading]=useState(false);
  const [toast,setToast]=useState(null);
  const [modal,setModal]=useState(null);
  const [progress,setProgress]=useState(0);
  const [files,setFiles]=useState([]);
  const [activeFileId,setActiveFileId]=useState(null);
  const [autoContinueCount,setAutoContinueCount]=useState(0);
  
  const editorRef=useRef(null);
  const monacoRef=useRef(null);

  const activeFile=files.find(f=>f.id===activeFileId);

  useEffect(()=>{
    storage.load();
    if(storage.data.files.length>0){
      setFiles(storage.data.files);
      if(storage.data.activeFileId){
        setActiveFileId(storage.data.activeFileId);
      }
    }
    
    lucide.createIcons();
    require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs"}});
    require(["vs/editor/editor.main"],(monaco)=>{
      monacoRef.current=monaco;
      editorRef.current=monaco.editor.create(document.getElementById("editor"),{
        value:"// Your generated code will appear here\n// Start by entering a prompt and clicking Generate!\n// Powered by Free, Unlimited Claude API via Puter",
        language:"plaintext",
        theme:"vs-dark",
        automaticLayout:true,
        minimap:{enabled:false},
        fontSize:14,
        lineHeight:22,
        fontFamily:"'Fira Code', 'Cascadia Code', Consolas, monospace",
        padding:{top:16,bottom:16}
      });
    });
  },[]);

  useEffect(()=>{
    if(activeFile&&editorRef.current){
      editorRef.current.setValue(activeFile.content);
      monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),activeFile.language);
    }
  },[activeFileId,activeFile]);

  useEffect(()=>{
    storage.data={files,activeFileId};
    storage.save();
  },[files,activeFileId]);

  function showToast(msg,type="info"){
    setToast({msg,type});
    setTimeout(()=>setToast(null),4000);
  }

  function showModal(title,body,type,onConfirm){
    setModal({title,body,type,onConfirm});
  }

  function closeModal(){
    setModal(null);
  }

  function autoGenerateFilename(){
    if(!prompt.trim()){
      showToast("Enter a prompt first","warning");
      return;
    }
    const tempCode=editorRef.current.getValue();
    const lang=detectLanguage(tempCode);
    const name=generateSmartFilename(prompt,tempCode,lang);
    setFilename(name);
    showToast("Filename generated!","success");
  }

  async function generate(){
    if(!prompt.trim()){
      showToast("Please enter a prompt to generate code","warning");
      return;
    }

    continueGeneration();
  }

  async function autoContinueIfNeeded(buffer,language,continueCount){
    // NO LIMIT - Continue until truly complete
    // Only safety check: buffer size to prevent infinite loops
    if(buffer.length>500000){
      showToast("‚ö†Ô∏è Maximum buffer size reached (500KB)","warning");
      return buffer;
    }
    
    // Check if code needs continuation
    if(!isCodeIncomplete(buffer,language)){
      showToast("‚úÖ Code generation complete!","success");
      return buffer;
    }
    
    // Wait a moment to ensure stream has truly stopped
    await new Promise(resolve=>setTimeout(resolve,1500));
    
    // Auto-continue detected - UNLIMITED
    setAutoContinueCount(continueCount+1);
    showToast(`üîÑ Auto-continuing generation (attempt ${continueCount+1})...`,"info");
    
    const system=`You are an elite code generation expert. Continue the code with these quality standards:
- Write complete, working code with NO placeholders
- Maintain the existing code style and patterns
- Include proper error handling
- Use best practices and clean code principles
- Complete all open functions, tags, and statements
- Return ONLY code - no explanations, no markdown
- Ensure the continuation is production-ready`;
    
    try{
      // Get last 1000 chars for context
      const context=buffer.slice(-1000);
      
      const cont=await puter.ai.chat([
        {role:"system",content:system},
        {role:"user",content:`Continue this code EXACTLY where it stops. DO NOT restart or explain, just continue:\n\n${context}\n\nComplete all open tags, functions, and statements.`}
      ],{model:"claude-sonnet-4-20250514",stream:true});

      let newBuffer=buffer;
      for await(const part of cont){
        const text=part?.text||"";
        newBuffer+=text;
        const cleaned=cleanCode(newBuffer);
        editorRef.current.setValue(cleaned);
      }
      
      const cleaned=cleanCode(newBuffer);
      
      // Recursively check if still incomplete - UNLIMITED
      return await autoContinueIfNeeded(cleaned,language,continueCount+1);
      
    }catch(e){
      showToast("Auto-continue error: "+e.message,"error");
      console.error("Auto-continue error:",e);
      
      // Retry once on error
      if(continueCount<50){
        await new Promise(resolve=>setTimeout(resolve,2000));
        return await autoContinueIfNeeded(buffer,language,continueCount+1);
      }
      
      return buffer;
    }
  }

  async function continueGeneration(){
    await ensurePuterAuth();

    closeModal();
    setLoading(true);
    setProgress(0);
    setAutoContinueCount(0);
    
    let buffer="";
    const system=`You are an elite code generation expert. Generate production-ready, fully functional code with these requirements:
- Write complete, working code with NO placeholders or TODOs
- Include proper error handling and edge cases
- Use best practices and clean code principles
- Add helpful comments for complex logic
- Ensure code is optimized and efficient
- Make it maintainable and scalable
- Return ONLY code - no markdown, no explanations, no text outside code
- Complete all functions, classes, and statements fully`;

    try{
      const progressInterval=setInterval(()=>{
        setProgress(p=>Math.min(p+1,95));
      },100);

      const res = await puter.ai.chat([
      {role:"system", content:system},
      {role:"user", content:prompt}
    ], { 
      model: "claude-4-5-sonnet", // Updated model string
      stream: true 
    });

    if(!res) throw new Error("No response from AI service");

    for await(const part of res){
      // ... streaming logic ...
    }
  } catch (e) {
    showToast("Generation failed: " + e.message, "error");
    setLoading(false);
  }

      let chunkCount=0;
      
      for await(const part of res){
        const text=part?.text||"";
        buffer+=text;
        chunkCount++;
        
        const cleaned=cleanCode(buffer);
        editorRef.current.setValue(cleaned);
      }

      clearInterval(progressInterval);

      const cleaned=cleanCode(buffer);
      const lang=detectLanguage(cleaned);
      monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),lang);

      // Automatic UNLIMITED continuation detection and execution
      showToast("üîç Checking if code is complete...","info");
      const finalCode=await autoContinueIfNeeded(cleaned,lang,0);
      
      // Auto-generate filename if not provided
      let finalFilename=filename.trim();
      if(!finalFilename){
        finalFilename=generateSmartFilename(prompt,finalCode,lang);
        setFilename(finalFilename);
      }

      // Create new file
      const newFile={
        id:Date.now().toString(),
        name:finalFilename,
        content:finalCode,
        language:lang,
        prompt:prompt,
        createdAt:new Date().toISOString(),
        size:finalCode.length
      };

      setFiles(prev=>[newFile,...prev]);
      setActiveFileId(newFile.id);
      
      setProgress(100);
      showToast(`‚ú® File "${finalFilename}" created successfully!`,"success");
      setPrompt("");
      setFilename("");

    }catch(e){
      showToast("Generation failed: "+e.message,"error");
      console.error("Generation error:",e);
    }
    
    setLoading(false);
    setProgress(0);
    setAutoContinueCount(0);
  }

  function selectFile(id){
    setActiveFileId(id);
    const file=files.find(f=>f.id===id);
    if(file){
      lucide.createIcons();
    }
  }

  function deleteFile(id,e){
    e.stopPropagation();
    showModal(
      "Delete File?",
      "Are you sure you want to delete this file? This action cannot be undone.",
      "danger",
      ()=>{
        setFiles(prev=>prev.filter(f=>f.id!==id));
        if(activeFileId===id){
          setActiveFileId(null);
          editorRef.current.setValue("// Select a file or generate new code");
          monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),"plaintext");
        }
        closeModal();
        showToast("File deleted","info");
      }
    );
  }

  function downloadFile(id,e){
    e.stopPropagation();
    const file=files.find(f=>f.id===id);
    if(!file)return;
    
    const blob=new Blob([file.content],{type:"text/plain"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=file.name;
    a.click();
    URL.revokeObjectURL(url);
    showToast(`"${file.name}" downloaded!`,"success");
  }

  function downloadAllFiles(){
    if(files.length===0){
      showToast("No files to download","warning");
      return;
    }
    
    files.forEach(file=>{
      setTimeout(()=>{
        const blob=new Blob([file.content],{type:"text/plain"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url;
        a.download=file.name;
        a.click();
        URL.revokeObjectURL(url);
      },100*files.indexOf(file));
    });
    
    showToast(`Downloading ${files.length} files...`,"success");
  }

  function copyCode(){
    if(!activeFile){
      showToast("No file selected","warning");
      return;
    }
    navigator.clipboard.writeText(activeFile.content);
    showToast("Code copied to clipboard!","success");
  }

  async function continueActiveFile(){
    await ensurePuterAuth();

    if(!activeFile){
      showToast("No file selected","warning");
      return;
    }

    setLoading(true);
    setProgress(0);
    setAutoContinueCount(0);
    showToast("Continuing code generation...","info");

    let buffer=activeFile.content;
    const system=`You are an elite code generation expert. Continue the code with these quality standards:
- Write complete, working code with NO placeholders
- Maintain the existing code style and patterns
- Include proper error handling
- Use best practices and clean code principles
- Complete all open functions, tags, and statements
- Return ONLY code - no explanations, no markdown
- Ensure the continuation is production-ready`;

    try{
      const progressInterval=setInterval(()=>{
        setProgress(p=>Math.min(p+2,95));
      },100);

      const context=buffer.slice(-800);
      
      const cont=await puter.ai.chat([
        {role:"system",content:system},
        {role:"user",content:`Continue this code EXACTLY where it stops:\n\n${context}\n\nComplete all open tags, functions, and statements.`}
      ],{model:"claude-sonnet-4-20250514",stream:true});

      for await(const part of cont){
        buffer+=part?.text||"";
        const cleaned=cleanCode(buffer);
        editorRef.current.setValue(cleaned);
      }

      clearInterval(progressInterval);

      const cleaned=cleanCode(buffer);
      
      // Auto-continue UNLIMITED if still incomplete
      const finalCode=await autoContinueIfNeeded(cleaned,activeFile.language,0);
      
      const updatedFile={...activeFile,content:finalCode,size:finalCode.length};
      setFiles(prev=>prev.map(f=>f.id===activeFile.id?updatedFile:f));

      setProgress(100);
      showToast(`‚ú® Code continued successfully!`,"success");

    }catch(e){
      showToast("Continue failed: "+e.message,"error");
    }

    setLoading(false);
    setProgress(0);
    setAutoContinueCount(0);
  }

  function clearAllFiles(){
    showModal(
      "Clear All Files?",
      "This will delete all generated files. This action cannot be undone.",
      "danger",
      ()=>{
        setFiles([]);
        setActiveFileId(null);
        editorRef.current.setValue("// All files cleared. Start fresh!");
        monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),"plaintext");
        closeModal();
        showToast("All files cleared","info");
      }
    );
  }

  return(
    <div className="app">
      <header>
        <div className="brand">
          <i data-lucide="code-2"></i>
          Re-Code AI
          <span style={{fontSize:"0.7rem",background:"rgba(110,243,197,.2)",padding:"4px 10px",borderRadius:"8px",marginLeft:"8px",color:"#6ef3c5",fontWeight:600}}>UNLIMITED</span>
        </div>
        <div className="credit-section">
          <div className="credit-display unlimited">
            <i data-lucide="infinity"></i>
            <span>Unlimited Access</span>
          </div>
        </div>
      </header>

      <div className="layout">
        <aside className="sidebar">
          <div className="sidebar-header">
            <div className="sidebar-title">
              <i data-lucide="folder"></i>
              Files ({files.length})
            </div>
            {files.length>0&&(
              <button className="icon-btn" onClick={clearAllFiles} title="Clear All">
                <i data-lucide="trash-2"></i>
              </button>
            )}
          </div>
          
          {files.length===0?(
            <div className="empty-state">
              <div><i data-lucide="inbox"></i></div>
              <div>No files yet</div>
              <div style={{fontSize:"0.8rem",marginTop:"8px"}}>Generate code to create files</div>
            </div>
          ):(
            <div className="file-list">
              {files.map(file=>(
                <div 
                  key={file.id} 
                  className={`file-item ${activeFileId===file.id?"active":""}`}
                  onClick={()=>selectFile(file.id)}
                >
                  <div className="file-info">
                    <div className="file-name" title={file.name}>{file.name}</div>
                    <div className="file-meta">{(file.size/1000).toFixed(1)}KB ‚Ä¢ {file.language}</div>
                  </div>
                  <div className="file-actions">
                    <button className="file-btn" onClick={(e)=>downloadFile(file.id,e)} title="Download">
                      <i data-lucide="download"></i>
                    </button>
                    <button className="file-btn" onClick={(e)=>deleteFile(file.id,e)} title="Delete">
                      <i data-lucide="trash-2"></i>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {files.length>1&&(
            <button className="secondary" onClick={downloadAllFiles} style={{width:"100%",marginTop:"12px",fontSize:"0.85rem",padding:"10px"}}>
              <i data-lucide="download-cloud"></i>
              <span>Download All</span>
            </button>
          )}
        </aside>

        <div className="main-content">
          <div className="main-panel">
            <div className="prompt-section">
              <div className="prompt-label">
                <i data-lucide="message-square"></i>
                What would you like to build?
                <span style={{marginLeft:"auto",fontSize:"0.75rem",background:"rgba(110,243,197,.15)",padding:"4px 10px",borderRadius:"6px",color:"#6ef3c5",display:"flex",alignItems:"center",gap:"4px"}}>
                  <i data-lucide="infinity" style={{width:"14px",height:"14px"}}></i>
                  Unlimited Auto-Complete
                </span>
                {loading&&autoContinueCount>0&&(
                  <span className="auto-continue-badge">
                    <i data-lucide="repeat" style={{width:"14px",height:"14px"}}></i>
                    Auto-Continue #{autoContinueCount}
                  </span>
                )}
              </div>
              <textarea 
                value={prompt} 
                onChange={e=>setPrompt(e.target.value)} 
                placeholder="Example: Create a responsive calculator with gradient design and keyboard support..."
                disabled={loading}
              />
              
              <div className="filename-section">
                <input 
                  type="text"
                  className="filename-input"
                  value={filename}
                  onChange={e=>setFilename(e.target.value)}
                  placeholder="Filename (auto-generated if empty)"
                  disabled={loading}
                />
                <button className="auto-name-btn" onClick={autoGenerateFilename} disabled={loading}>
                  <i data-lucide="wand-2" style={{width:"16px",height:"16px"}}></i> Auto
                </button>
              </div>
              
              {prompt&&(
                <div className="token-estimate">
                  <i data-lucide="info"></i>
                  <span style={{color:"#6ef3c5"}}>‚ú® Free, Unlimited Claude API via Puter</span>
                  <span>‚Ä¢</span>
                  <span style={{color:"#6ef3c5"}}>‚ôæÔ∏è No credit limits</span>
                  <span>‚Ä¢</span>
                  <span style={{color:"#6ef3c5"}}>üîÑ Unlimited auto-complete</span>
                </div>
              )}
            </div>

            <div className="actions">
              <button className="primary" onClick={generate} disabled={loading||!prompt.trim()}>
                <i data-lucide={loading?"loader":"sparkles"}></i>
                <span>{loading?"Generating...":"Generate Code"}</span>
              </button>
              <button className="secondary" onClick={copyCode} disabled={!activeFile}>
                <i data-lucide="copy"></i>
                <span>Copy</span>
              </button>
              {activeFile&&(
                <button className="secondary" onClick={continueActiveFile} disabled={loading}>
                  <i data-lucide="play-circle"></i>
                  <span>Continue Code</span>
                </button>
              )}
            </div>

            <div className={`progress-container ${loading?"active":""}`}>
              <div className="progress-bar">
                <div className="progress-fill" style={{width:`${progress}%`}}></div>
              </div>
              <div className="progress-text">
                {autoContinueCount>0?`Auto-continuing generation (#${autoContinueCount})... ${progress}%`:`Generating your code... ${progress}%`}
              </div>
            </div>
          </div>

          <div className="editor-container">
            <div className="editor-header">
              <div className="editor-title">
                <i data-lucide="code"></i>
                {activeFile?activeFile.name:"Editor"}
              </div>
              <div className="editor-actions">
                {activeFile&&(
                  <div style={{fontSize:"0.9rem",color:"#94a3b8",marginRight:"12px"}}>
                    Language: <span style={{color:"#6ef3c5",fontWeight:700}}>{activeFile.language}</span>
                  </div>
                )}
              </div>
            </div>
            <div id="editor"></div>
            <div className="stats">
              <div className="stat-item">
                <i data-lucide="files"></i>
                <span>Total Files: <span className="stat-value">{files.length}</span></span>
              </div>
              {activeFile&&(
                <>
                  <div className="stat-item">
                    <i data-lucide="file-text"></i>
                    <span>Characters: <span className="stat-value">{activeFile.size.toLocaleString()}</span></span>
                  </div>
                  <div className="stat-item">
                    <i data-lucide="layers"></i>
                    <span>Lines: <span className="stat-value">{activeFile.content.split('\n').length}</span></span>
                  </div>
                </>
              )}
              <div className="stat-item" style={{color:"#6ef3c5"}}>
                <i data-lucide="infinity"></i>
                <span>Mode: <span className="stat-value">Unlimited</span></span>
              </div>
              <div className="stat-item" style={{color:"#6ef3c5"}}>
                <i data-lucide="shield-check"></i>
                <span>Quality: <span className="stat-value">Premium</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {toast&&(
        <div className={`toast ${toast.type}`}>
          <i data-lucide={
            toast.type==="success"?"check-circle":
            toast.type==="error"?"x-circle":
            toast.type==="warning"?"alert-triangle":
            "info"
          }></i>
          <span>{toast.msg}</span>
        </div>
      )}

      {modal&&(
        <div className="modal-overlay" onClick={closeModal}>
          <div className={`modal ${modal.type}`} onClick={e=>e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-icon">
                <i data-lucide={modal.type==="warning"?"alert-triangle":"alert-circle"}></i>
              </div>
              <div className="modal-title">{modal.title}</div>
            </div>
            <div className="modal-body">{modal.body}</div>
            <div className="modal-actions">
              {modal.onConfirm&&(
                <button className="primary" onClick={modal.onConfirm}>
                  <i data-lucide="check"></i>
                  <span>Continue</span>
                </button>
              )}
              <button className="secondary" onClick={closeModal}>
                <i data-lucide="x"></i>
                <span>{modal.onConfirm?"Cancel":"Close"}</span>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Re-Code | Re-EL's Advanced Coding AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Puter AI -->
<script src="https://js.puter.com/v2/"></script>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Monaco Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/editor/editor.main.css" />
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,system-ui,sans-serif;background:#0a0e1a;color:#f1f5f9;overflow-x:hidden}
.app{max-width:1800px;margin:auto;padding:20px;position:relative}
.layout{display:grid;grid-template-columns:280px 1fr;gap:20px}

/* Header */
header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);padding:20px 28px;border-radius:20px;margin-bottom:4px;border:1px solid rgba(110,243,197,.2);box-shadow:0 8px 32px rgba(0,0,0,.3);animation:slideDown 0.6s ease}
.brand{display:flex;align-items:center;gap:12px;font-size:1.6rem;font-weight:900;background:linear-gradient(135deg,#6ef3c5,#4ade80);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.brand i{color:#6ef3c5;animation:pulse 2s ease infinite}

/* Credit System */
.credit-section{display:flex;align-items:center;gap:16px}
.credit-display{display:flex;align-items:center;gap:10px;padding:10px 20px;border-radius:14px;background:rgba(110,243,197,.1);border:2px solid rgba(110,243,197,.3);font-weight:700;font-size:1rem;transition:all 0.3s}
.credit-display.warning{background:rgba(251,191,36,.1);border-color:rgba(251,191,36,.5);animation:warningPulse 1.5s ease infinite}
.credit-display.danger{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.5);animation:dangerPulse 1s ease infinite}
.credit-bar{width:120px;height:8px;background:#020617;border-radius:10px;overflow:hidden;border:1px solid #1e293b}
.credit-fill{height:100%;background:linear-gradient(90deg,#6ef3c5,#4ade80);transition:all 0.5s ease;border-radius:10px}
.credit-fill.warning{background:linear-gradient(90deg,#fbbf24,#f59e0b)}
.credit-fill.danger{background:linear-gradient(90deg,#ef4444,#dc2626)}

/* Sidebar - File Explorer */
.sidebar{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:fadeIn 0.6s ease;max-height:calc(100vh - 140px);overflow-y:auto}
.sidebar-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.1)}
.sidebar-title{display:flex;align-items:center;gap:8px;font-weight:700;color:#6ef3c5;font-size:1rem}
.file-list{display:flex;flex-direction:column;gap:8px}
.file-item{padding:12px 14px;background:rgba(2,6,23,.6);border:1px solid #1e293b;border-radius:12px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:space-between;gap:8px}
.file-item:hover{border-color:#6ef3c5;background:rgba(110,243,197,.05);transform:translateX(4px)}
.file-item.active{border-color:#6ef3c5;background:rgba(110,243,197,.1)}
.file-info{flex:1;min-width:0}
.file-name{font-weight:600;font-size:0.9rem;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-meta{font-size:0.75rem;color:#64748b;margin-top:2px}
.file-actions{display:flex;gap:4px}
.file-btn{padding:6px;background:transparent;border:none;cursor:pointer;color:#94a3b8;border-radius:6px;transition:all 0.2s}
.file-btn:hover{background:rgba(110,243,197,.2);color:#6ef3c5}
.empty-state{text-align:center;padding:40px 20px;color:#64748b;font-size:0.9rem}
.empty-state i{font-size:3rem;margin-bottom:12px;opacity:0.3}

/* Main Content */
.main-content{display:flex;flex-direction:column;gap:20px}
.main-panel{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:fadeIn 0.6s ease}
.prompt-section{position:relative}
.prompt-label{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-weight:600;color:#6ef3c5;font-size:1rem}
textarea{width:100%;min-height:120px;background:rgba(2,6,23,.8);color:#e5e7eb;border-radius:16px;border:2px solid #1e293b;padding:16px;resize:vertical;font-size:0.95rem;line-height:1.6;transition:all 0.3s;font-family:inherit}
textarea:focus{outline:none;border-color:#6ef3c5;box-shadow:0 0 0 3px rgba(110,243,197,.1)}
textarea::placeholder{color:#64748b}

/* Filename Input */
.filename-section{margin-top:12px;display:flex;gap:8px;align-items:center}
.filename-input{flex:1;background:rgba(2,6,23,.8);color:#e5e7eb;border-radius:12px;border:2px solid #1e293b;padding:10px 14px;font-size:0.9rem;transition:all 0.3s}
.filename-input:focus{outline:none;border-color:#6ef3c5;box-shadow:0 0 0 3px rgba(110,243,197,.1)}
.auto-name-btn{padding:10px 16px;background:rgba(110,243,197,.1);border:1px solid rgba(110,243,197,.3);border-radius:10px;color:#6ef3c5;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.3s}
.auto-name-btn:hover{background:rgba(110,243,197,.2);transform:scale(1.02)}

/* Token Estimation */
.token-estimate{display:flex;align-items:center;gap:12px;margin-top:12px;padding:12px 16px;background:rgba(110,243,197,.05);border-radius:12px;border:1px solid rgba(110,243,197,.15);font-size:0.9rem;color:#94a3b8}
.token-estimate i{color:#6ef3c5}
.token-cost{font-weight:700;color:#6ef3c5}

/* Actions */
.actions{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
button{padding:14px 24px;border:none;border-radius:14px;font-weight:700;cursor:pointer;font-size:0.95rem;display:flex;align-items:center;gap:8px;transition:all 0.3s;position:relative;overflow:hidden}
button:before{content:"";position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.2);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s}
button:hover:before{width:300px;height:300px}
button.primary{background:linear-gradient(135deg,#6ef3c5,#4ade80);color:#000;box-shadow:0 4px 16px rgba(110,243,197,.3)}
button.primary:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(110,243,197,.4)}
button.secondary{background:#020617;color:#e5e7eb;border:2px solid #1e293b}
button.secondary:hover{border-color:#6ef3c5;background:#0a1628}
button:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
button i{z-index:1}
button span{z-index:1}

/* Progress Bar */
.progress-container{margin-top:16px;display:none}
.progress-container.active{display:block;animation:fadeIn 0.3s}
.progress-bar{width:100%;height:6px;background:#020617;border-radius:10px;overflow:hidden;border:1px solid #1e293b}
.progress-fill{height:100%;background:linear-gradient(90deg,#6ef3c5,#4ade80,#6ef3c5);background-size:200% 100%;animation:progressShimmer 2s linear infinite;transition:width 0.3s}
.progress-text{margin-top:8px;font-size:0.85rem;color:#94a3b8;text-align:center}

/* Auto-continue Indicator */
.auto-continue-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.4);border-radius:8px;font-size:0.8rem;color:#fbbf24;font-weight:600;animation:pulse 2s ease infinite}

/* Editor Container */
.editor-container{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:fadeIn 0.8s ease}
.editor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.editor-title{display:flex;align-items:center;gap:8px;font-weight:700;color:#6ef3c5;font-size:1.1rem}
.editor-actions{display:flex;gap:8px}
.icon-btn{padding:10px;border:none;background:rgba(110,243,197,.1);border-radius:10px;cursor:pointer;transition:all 0.3s;color:#6ef3c5;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{background:rgba(110,243,197,.2);transform:scale(1.05)}
.icon-btn:disabled{opacity:.5;cursor:not-allowed}
#editor{height:500px;border-radius:16px;border:2px solid #1e293b;overflow:hidden;box-shadow:inset 0 2px 8px rgba(0,0,0,.3)}

/* Stats */
.stats{display:flex;gap:24px;margin-top:16px;padding:16px;background:rgba(2,6,23,.6);border-radius:12px;border:1px solid #1e293b;flex-wrap:wrap}
.stat-item{display:flex;align-items:center;gap:8px;font-size:0.9rem;color:#94a3b8}
.stat-item i{color:#6ef3c5}
.stat-value{font-weight:700;color:#e5e7eb}

/* Toast System */
.toast{position:fixed;bottom:24px;right:24px;background:rgba(2,6,23,.95);backdrop-filter:blur(20px);border:2px solid;padding:16px 24px;border-radius:16px;display:flex;align-items:center;gap:12px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideIn 0.3s ease;z-index:1000;max-width:400px}
.toast.success{border-color:#4ade80;color:#4ade80}
.toast.error{border-color:#ef4444;color:#ef4444}
.toast.warning{border-color:#fbbf24;color:#fbbf24}
.toast.info{border-color:#6ef3c5;color:#6ef3c5}
.toast i{flex-shrink:0}

/* Alert Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:2000;animation:fadeIn 0.3s}
.modal{background:rgba(2,6,23,.98);border:2px solid;border-radius:20px;padding:32px;max-width:500px;width:90%;box-shadow:0 16px 64px rgba(0,0,0,.7);animation:scaleIn 0.3s ease}
.modal.warning{border-color:#fbbf24}
.modal.danger{border-color:#ef4444}
.modal-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.modal-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px}
.modal.warning .modal-icon{background:rgba(251,191,36,.2);color:#fbbf24}
.modal.danger .modal-icon{background:rgba(239,68,68,.2);color:#ef4444}
.modal-title{font-size:1.4rem;font-weight:800}
.modal-body{color:#94a3b8;line-height:1.6;margin-bottom:24px}
.modal-actions{display:flex;gap:12px}

/* Animations */
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes warningPulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.4)}50%{box-shadow:0 0 0 8px rgba(251,191,36,0)}}
@keyframes dangerPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
@keyframes progressShimmer{0%{background-position:0% 0}100%{background-position:200% 0}}

/* Responsive */
@media(max-width:1024px){
  .layout{grid-template-columns:1fr}
  .sidebar{max-height:300px}
}
@media(max-width:768px){
  header{flex-direction:column;gap:16px;text-align:center}
  .actions{flex-direction:column}
  button{width:100%;justify-content:center}
  .stats{flex-direction:column;gap:12px}
  #editor{height:400px}
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

// Storage Manager (uses in-memory but structured for easy localStorage conversion)
const storage={
  data:{files:[],credits:1000,activeFileId:null},
  save(){
    // In-memory storage (persists during browser session)
  },
  load(){
  }
};

function cleanCode(raw){
  return raw
    .replace(/```[\s\S]*?```/g,m=>m.replace(/```[\w]*\n?|```/g,""))
    .replace(/```/g,"")
    .replace(/I don't see any previous code.*$/s,'')
    .replace(/Could you please share.*$/s,'')
    .replace(/I'll continue.*$/s,'')
    .replace(/Let me continue.*$/s,'')
    .trim();
}

function detectLanguage(code){
  if(!code||code.length<10)return"plaintext";
  if(code.startsWith("<!DOCTYPE")||code.startsWith("<html")||/<html[\s>]/.test(code))return"html";
  if(/import React|from ['"]react['"]|const.*=.*React/.test(code))return"javascript";
  if(/def\s+\w+\(|import\s+\w+|print\(/.test(code))return"python";
  if(/System\.out\.print|public\s+class|public\s+static\s+void/.test(code))return"java";
  if(/#include\s*<|using namespace|std::/.test(code))return"cpp";
  if(/func\s+\w+\(|let\s+\w+:|var\s+\w+:/.test(code))return"swift";
  if(/fn\s+\w+\(|impl\s|pub\s+fn/.test(code))return"rust";
  if(/<?php|function\s+\w+\(.*\)\s*{/.test(code))return"php";
  if(/interface\s+\w+|type\s+\w+\s*=/.test(code))return"typescript";
  return"javascript";
}

function generateSmartFilename(prompt,code,lang){
  const keywords=prompt.toLowerCase().match(/\b(todo|calculator|game|chat|form|dashboard|api|app|component|website|page|tool|system)\b/g);
  const mainKeyword=keywords?keywords[0]:"code";
  
  const extensions={
    javascript:"js",typescript:"ts",html:"html",python:"py",
    java:"java",cpp:"cpp",rust:"rs",swift:"swift",php:"php"
  };
  const ext=extensions[lang]||"txt";
  
  let name=mainKeyword;
  if(lang==="javascript"||lang==="typescript"){
    const match=code.match(/(?:class|function|const)\s+(\w+)/);
    if(match)name=match[1].toLowerCase();
  }else if(lang==="python"){
    const match=code.match(/def\s+(\w+)|class\s+(\w+)/);
    if(match)name=(match[1]||match[2]).toLowerCase();
  }else if(lang==="java"){
    const match=code.match(/class\s+(\w+)/);
    if(match)name=match[1].toLowerCase();
  }
  
  return`${name}.${ext}`;
}

function estimateTokens(text){
  return Math.ceil(text.length/4);
}

function estimateCost(tokens){
  return Math.ceil(tokens/50);
}

function App(){
  const [prompt,setPrompt]=useState("");
  const [filename,setFilename]=useState("");
  const [loading,setLoading]=useState(false);
  const [credits,setCredits]=useState(1000);
  const [maxCredits]=useState(1000);
  const [toast,setToast]=useState(null);
  const [modal,setModal]=useState(null);
  const [progress,setProgress]=useState(0);
  const [files,setFiles]=useState([]);
  const [activeFileId,setActiveFileId]=useState(null);
  const [autoContinueActive,setAutoContinueActive]=useState(false);
  
  const editorRef=useRef(null);
  const monacoRef=useRef(null);
  const lastEditorChangeRef=useRef(null);
  const editorCheckIntervalRef=useRef(null);
  const streamTimeoutRef=useRef(null);
  const savedCodeBufferRef=useRef("");
  const generationActiveRef=useRef(false);
  const sdkLoadedRef=useRef(false);

  const activeFile=files.find(f=>f.id===activeFileId);

  useEffect(()=>{
    storage.load();
    if(storage.data.files.length>0){
      setFiles(storage.data.files);
      setCredits(storage.data.credits);
      if(storage.data.activeFileId){
        setActiveFileId(storage.data.activeFileId);
      }
    }
    
    lucide.createIcons();
    require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs"}});
    require(["vs/editor/editor.main"],(monaco)=>{
      monacoRef.current=monaco;
      editorRef.current=monaco.editor.create(document.getElementById("editor"),{
        value:"// Your generated code will appear here\n// Start by entering a prompt and clicking Generate!",
        language:"plaintext",
        theme:"vs-dark",
        automaticLayout:true,
        minimap:{enabled:false},
        fontSize:14,
        lineHeight:22,
        fontFamily:"'Fira Code', 'Cascadia Code', Consolas, monospace",
        padding:{top:16,bottom:16}
      });
    });
    
    // Cleanup on unmount
    return()=>{
      killAllIntervals();
    };
  },[]);

  // Auto-continue monitor: watches for editor stalls during generation
  // After 90s of no changes: deletes zombie SDK, reloads fresh, continues generation
  // Uses 20s hard timeout per stream - kills and retries if no chunks arrive
  useEffect(()=>{
    if(loading&&generationActiveRef.current){
      lastEditorChangeRef.current=Date.now();
      
      editorCheckIntervalRef.current=setInterval(()=>{
        const timeSinceLastChange=Date.now()-lastEditorChangeRef.current;
        
        // If editor hasn't changed in 90 seconds, trigger auto-continue
        if(timeSinceLastChange>=90000&&!autoContinueActive){
          console.log("‚ö†Ô∏è Editor stalled for 90s - triggering auto-continue with fresh auth");
          setAutoContinueActive(true);
          autoResumeGeneration();
        }
      },2000); // Check every 2 seconds
      
      return()=>{
        killAllIntervals();
      };
    }else{
      killAllIntervals();
    }
  },[loading,autoContinueActive]);

  useEffect(()=>{
    if(activeFile&&editorRef.current){
      editorRef.current.setValue(activeFile.content);
      monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),activeFile.language);
    }
  },[activeFileId,activeFile]);

  useEffect(()=>{
    storage.data={files,credits,activeFileId};
    storage.save();
  },[files,credits,activeFileId]);

  useEffect(()=>{
    lucide.createIcons();
  },[toast,modal,files,autoContinueActive]);

  function killAllIntervals(){
    console.log("üî™ Killing all intervals and timeouts aggressively");
    if(editorCheckIntervalRef.current){
      clearInterval(editorCheckIntervalRef.current);
      editorCheckIntervalRef.current=null;
    }
    if(streamTimeoutRef.current){
      clearTimeout(streamTimeoutRef.current);
      streamTimeoutRef.current=null;
    }
  }

  async function reloadPuterSDK(){
    console.log("‚ôªÔ∏è Reloading Puter SDK dynamically...");
    
    // Kill zombie SDK instance
    if(window.puter?.ai){
      try{
        delete window.puter;
        console.log("‚úÖ Deleted old Puter SDK instance");
      }catch(e){
        console.warn("Could not delete puter:",e);
      }
    }
    
    // Remove old script tag if exists
    const oldScript=document.querySelector('script[src*="puter.com"]');
    if(oldScript){
      oldScript.remove();
    }
    
    // Load fresh SDK
    return new Promise((resolve,reject)=>{
      const script=document.createElement('script');
      script.src='https://js.puter.com/v2/';
      script.onload=()=>{
        console.log("‚úÖ Fresh Puter SDK loaded");
        sdkLoadedRef.current=true;
        // Give SDK time to initialize
        setTimeout(resolve,1000);
      };
      script.onerror=()=>{
        console.error("‚ùå Failed to reload Puter SDK");
        reject(new Error("SDK reload failed"));
      };
      document.head.appendChild(script);
    });
  }

  function showToast(msg,type="info"){
    setToast({msg,type});
    setTimeout(()=>setToast(null),4000);
  }

  function showModal(title,body,type,onConfirm){
    setModal({title,body,type,onConfirm});
  }

  function closeModal(){
    setModal(null);
  }

  function autoGenerateFilename(){
    if(!prompt.trim()){
      showToast("Enter a prompt first","warning");
      return;
    }
    const tempCode=editorRef.current.getValue();
    const lang=detectLanguage(tempCode);
    const name=generateSmartFilename(prompt,tempCode,lang);
    setFilename(name);
    showToast("Filename generated!","success");
  }

  const estimatedCost=estimateCost(estimateTokens(prompt));
  const creditPercent=(credits/maxCredits)*100;
  const creditStatus=creditPercent<=10?"danger":creditPercent<=30?"warning":"normal";

  async function autoResumeGeneration(){
    console.log("üîÑ Auto-resuming generation - killing zombie instances...");
    
    // Kill all intervals first
    killAllIntervals();
    
    // Save current editor state
    const currentCode=editorRef.current.getValue();
    savedCodeBufferRef.current=currentCode;
    
    showToast("‚ôªÔ∏è Killing old SDK & reloading fresh...","info");
    
    // Delete zombie SDK and reload fresh
    try{
      await reloadPuterSDK();
      showToast("‚úÖ Fresh SDK loaded, continuing generation...","success");
    }catch(sdkErr){
      console.error("SDK reload failed:",sdkErr);
      showToast("SDK reload failed, attempting anyway...","warning");
    }
    
    // Get last 1000 chars for context
    const context=currentCode.slice(-1000);
    
    const system=`You are an elite code generation expert. Continue the code EXACTLY where it stopped:
- Pick up from the EXACT last character/symbol in the provided code
- Do NOT repeat any existing code - only add NEW continuation
- Maintain the existing code style and patterns perfectly
- Complete all open functions, tags, brackets, and statements
- Write complete, working code with NO placeholders
- Include proper error handling
- Return ONLY the CONTINUATION code - no explanations, no markdown
- Ensure seamless merge: your output will be appended directly to existing code`;

    // Verify SDK is loaded
    if(!window.puter?.ai){
      console.warn("‚ö†Ô∏è Puter SDK not available, reloading...");
      try{
        await reloadPuterSDK();
      }catch(sdkErr){
        showToast("SDK unavailable - cannot continue","error");
        setAutoContinueActive(false);
        return;
      }
    }

    try{
      const cont=await puter.ai.chat([
        {role:"system",content:system},
        {role:"user",content:`Continue this code EXACTLY where it stops. Complete all open statements:\n\n${context}`}
      ],{model:"claude-sonnet-4-20250514",stream:true});

      let newBuffer=savedCodeBufferRef.current;
      let hasReceivedData=false;
      
      for await(const part of cont){
        const text=part?.text||"";
        if(text){
          hasReceivedData=true;
          newBuffer+=text;
          const cleaned=cleanCode(newBuffer);
          editorRef.current.setValue(cleaned);
          lastEditorChangeRef.current=Date.now(); // Reset timer
        }
      }

      if(!hasReceivedData){
        throw new Error("No data received from API");
      }

      savedCodeBufferRef.current=newBuffer;
      setAutoContinueActive(false);
      
      const cost=Math.ceil((newBuffer.length-currentCode.length)/200);
      setCredits(prev=>Math.max(prev-cost,0));
      
      showToast("‚úÖ Auto-continue completed successfully!","success");
      
    }catch(e){
      console.error("Auto-continue error:",e);
      setAutoContinueActive(false);
      
      // Retry once with fresh connection
      if(!e.retried){
        console.log("üîÑ Retrying with fresh auth and connection...");
        showToast("Retrying with fresh authentication...","warning");
        
        setTimeout(async()=>{
          try{
            // Clear old token and reauth for retry
            try{
              if(window.puter?.authToken){
                delete window.puter.authToken;
              }
            }catch(clearErr){}
            
            await new Promise(resolve=>setTimeout(resolve,500));
            
            const retryContext=savedCodeBufferRef.current.slice(-1000);
            const retryCont=await puter.ai.chat([
              {role:"system",content:system},
              {role:"user",content:`Continue this code EXACTLY where it stops:\n\n${retryContext}`}
            ],{model:"claude-sonnet-4-20250514",stream:true});
            
            let retryBuffer=savedCodeBufferRef.current;
            for await(const part of retryCont){
              const text=part?.text||"";
              if(text){
                retryBuffer+=text;
                const cleaned=cleanCode(retryBuffer);
                editorRef.current.setValue(cleaned);
                lastEditorChangeRef.current=Date.now();
              }
            }
            
            savedCodeBufferRef.current=retryBuffer;
            setAutoContinueActive(false);
            
            const retryCost=Math.ceil((retryBuffer.length-currentCode.length)/200);
            setCredits(prev=>Math.max(prev-retryCost,0));
            
            showToast("‚úÖ Auto-continue retry successful!","success");
          }catch(retryErr){
            console.error("Retry failed:",retryErr);
            showToast("Auto-continue failed after retry: "+retryErr.message,"error");
            setAutoContinueActive(false);
          }
        },1000);
        
        e.retried=true;
      }else{
        showToast("Auto-continue failed: "+e.message,"error");
      }
    }
  }

  async function generate(){
    if(!prompt.trim()){
      showToast("Please enter a prompt to generate code","warning");
      return;
    }

    const estimatedCost=estimateCost(estimateTokens(prompt));
    
    if(credits<=0){
      showModal(
        "No Credits Remaining",
        "You've run out of credits and cannot generate code. Please reset your credits or wait for them to replenish.",
        "danger",
        null
      );
      return;
    }

    if(credits<estimatedCost){
      showModal(
        "Insufficient Credits",
        `This generation will cost approximately ${estimatedCost} credits, but you only have ${credits} credits remaining. The generation may be cut short.`,
        "warning",
        ()=>continueGeneration()
      );
      return;
    }

    if(credits<=100){
      showModal(
        "Low Credits Warning",
        `You have ${credits} credits remaining. This generation will cost approximately ${estimatedCost} credits. Continue anyway?`,
        "warning",
        ()=>continueGeneration()
      );
      return;
    }

    continueGeneration();
  }

  async function continueGeneration(){
    closeModal();
    
    // Kill all intervals before starting
    killAllIntervals();
    
    setLoading(true);
    setProgress(0);
    generationActiveRef.current=true;
    setAutoContinueActive(false);
    lastEditorChangeRef.current=Date.now();
    
    let buffer="";
    savedCodeBufferRef.current="";
    
    const system=`You are an elite code generation expert. Generate production-ready, fully functional code with these requirements:
- Write complete, working code with NO placeholders or TODOs
- Include proper error handling and edge cases
- Use best practices and clean code principles
- Add helpful comments for complex logic
- Ensure code is optimized and efficient
- Make it maintainable and scalable
- Return ONLY code - no markdown, no explanations, no text outside code
- Complete all functions, classes, and statements fully`;

    try{
      const progressInterval=setInterval(()=>{
        setProgress(p=>Math.min(p+1,95));
      },100);

      // Set hard timeout for stream
      let firstChunkReceived=false;
      streamTimeoutRef.current=setTimeout(()=>{
        if(!firstChunkReceived){
          clearInterval(progressInterval);
          throw new Error("Initial stream stalled - no data in 20 seconds");
        }
      },20000);

      const res=await puter.ai.chat([
        {role:"system",content:system},
        {role:"user",content:prompt}
      ],{model:"claude-sonnet-4-20250514",stream:true});

      let chunkCount=0;
      for await(const part of res){
        const text=part?.text||"";
        buffer+=text;
        chunkCount++;
        
        // Clear timeout on first chunk
        if(!firstChunkReceived&&text){
          if(streamTimeoutRef.current){
            clearTimeout(streamTimeoutRef.current);
            streamTimeoutRef.current=null;
          }
          firstChunkReceived=true;
          console.log("‚úÖ Stream active - receiving data");
        }
        
        const cleaned=cleanCode(buffer);
        editorRef.current.setValue(cleaned);
        savedCodeBufferRef.current=cleaned;
        lastEditorChangeRef.current=Date.now(); // Update change time

        if(chunkCount%10===0){
          const currentCost=Math.ceil(cleaned.length/200);
          if(credits-currentCost<=0){
            showToast("Credits exhausted during generation!","warning");
            break;
          }
        }
      }

      clearInterval(progressInterval);
      
      // Clean up timeout
      if(streamTimeoutRef.current){
        clearTimeout(streamTimeoutRef.current);
        streamTimeoutRef.current=null;
      }

      const final=cleanCode(buffer);
      const lang=detectLanguage(final);
      monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),lang);

      let finalFilename=filename.trim();
      if(!finalFilename){
        finalFilename=generateSmartFilename(prompt,final,lang);
        setFilename(finalFilename);
      }

      const newFile={
        id:Date.now().toString(),
        name:finalFilename,
        content:final,
        language:lang,
        prompt:prompt,
        createdAt:new Date().toISOString(),
        size:final.length
      };

      setFiles(prev=>[newFile,...prev]);
      setActiveFileId(newFile.id);

      const totalCost=Math.ceil(final.length/150);
      const newCredits=Math.max(credits-totalCost,0);
      setCredits(newCredits);
      
      setProgress(100);
      showToast(`File "${finalFilename}" created! Used ${totalCost} credits.`,"success");
      setPrompt("");
      setFilename("");

      if(newCredits<=100&&newCredits>0){
        setTimeout(()=>{
          showModal(
            "Low Credits Alert",
            `You now have only ${newCredits} credits remaining. You may want to be mindful of your usage.`,
            "warning",
            null
          );
        },2000);
      }

    }catch(e){
      killAllIntervals();
      showToast("Generation failed: "+e.message,"error");
    }
    
    generationActiveRef.current=false;
    setLoading(false);
    setProgress(0);
    setAutoContinueActive(false);
    killAllIntervals(); // Final cleanup
  }

  function selectFile(id){
    setActiveFileId(id);
  }

  function deleteFile(id,e){
    e.stopPropagation();
    showModal(
      "Delete File?",
      "Are you sure you want to delete this file? This action cannot be undone.",
      "danger",
      ()=>{
        setFiles(prev=>prev.filter(f=>f.id!==id));
        if(activeFileId===id){
          setActiveFileId(null);
          editorRef.current.setValue("// Select a file or generate new code");
          monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),"plaintext");
        }
        closeModal();
        showToast("File deleted","info");
      }
    );
  }

  function downloadFile(id,e){
    e.stopPropagation();
    const file=files.find(f=>f.id===id);
    if(!file)return;
    
    const blob=new Blob([file.content],{type:"text/plain"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=file.name;
    a.click();
    URL.revokeObjectURL(url);
    showToast(`"${file.name}" downloaded!`,"success");
  }

  function downloadAllFiles(){
    if(files.length===0){
      showToast("No files to download","warning");
      return;
    }
    
    files.forEach(file=>{
      setTimeout(()=>{
        const blob=new Blob([file.content],{type:"text/plain"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url;
        a.download=file.name;
        a.click();
        URL.revokeObjectURL(url);
      },100*files.indexOf(file));
    });
    
    showToast(`Downloading ${files.length} files...`,"success");
  }

  function copyCode(){
    if(!activeFile){
      showToast("No file selected","warning");
      return;
    }
    navigator.clipboard.writeText(activeFile.content);
    showToast("Code copied to clipboard!","success");
  }

  async function continueActiveFile(){
    if(!activeFile){
      showToast("No file selected","warning");
      return;
    }

    if(credits<=0){
      showToast("No credits remaining","error");
      return;
    }

    // Kill all intervals before starting
    killAllIntervals();

    setLoading(true);
    setProgress(0);
    generationActiveRef.current=true;
    lastEditorChangeRef.current=Date.now();
    showToast("Continuing code generation...","info");

    let buffer=activeFile.content;
    savedCodeBufferRef.current=buffer;
    
    const system=`You are an elite code generation expert. Continue the code with these quality standards:
- Write complete, working code with NO placeholders
- Maintain the existing code style and patterns
- Include proper error handling
- Use best practices and clean code principles
- Complete all open functions, tags, and statements
- Return ONLY code - no explanations, no markdown
- Ensure the continuation is production-ready`;

    try{
      const progressInterval=setInterval(()=>{
        setProgress(p=>Math.min(p+2,95));
      },100);

      const context=buffer.slice(-800);
      
      // Set hard timeout for stream
      let firstChunkReceived=false;
      streamTimeoutRef.current=setTimeout(()=>{
        if(!firstChunkReceived){
          clearInterval(progressInterval);
          throw new Error("Continue stream stalled - no data in 20 seconds");
        }
      },20000);
      
      const cont=await puter.ai.chat([
        {role:"system",content:system},
        {role:"user",content:`Continue this code EXACTLY where it stops:\n\n${context}\n\nComplete all open tags, functions, and statements.`}
      ],{model:"claude-sonnet-4-20250514",stream:true});

      for await(const part of cont){
        const text=part?.text||"";
        if(text){
          // Clear timeout on first chunk
          if(!firstChunkReceived){
            if(streamTimeoutRef.current){
              clearTimeout(streamTimeoutRef.current);
              streamTimeoutRef.current=null;
            }
            firstChunkReceived=true;
          }
          
          buffer+=text;
          const cleaned=cleanCode(buffer);
          editorRef.current.setValue(cleaned);
          savedCodeBufferRef.current=cleaned;
          lastEditorChangeRef.current=Date.now();
        }
      }

      clearInterval(progressInterval);
      
      // Clean up timeout
      if(streamTimeoutRef.current){
        clearTimeout(streamTimeoutRef.current);
        streamTimeoutRef.current=null;
      }

      const final=cleanCode(buffer);
      const updatedFile={...activeFile,content:final,size:final.length};
      setFiles(prev=>prev.map(f=>f.id===activeFile.id?updatedFile:f));

      const cost=Math.ceil((final.length-activeFile.size)/200);
      setCredits(prev=>Math.max(prev-cost,0));

      setProgress(100);
      showToast(`‚ú® Code continued successfully! Used ${cost} credits.`,"success");

    }catch(e){
      killAllIntervals();
      showToast("Continue failed: "+e.message,"error");
    }

    generationActiveRef.current=false;
    setLoading(false);
    setProgress(0);
    killAllIntervals(); // Final cleanup
  }

  function resetCredits(){
    setCredits(1000);
    showToast("Credits reset to 1000","success");
  }

  function clearAllFiles(){
    showModal(
      "Clear All Files?",
      "This will delete all generated files. This action cannot be undone.",
      "danger",
      ()=>{
        setFiles([]);
        setActiveFileId(null);
        editorRef.current.setValue("// All files cleared. Start fresh!");
        monacoRef.current.editor.setModelLanguage(editorRef.current.getModel(),"plaintext");
        closeModal();
        showToast("All files cleared","info");
      }
    );
  }

  return(
    <div className="app">
      <header>
        <div className="brand">
          <i data-lucide="code-2"></i>
          Re-Code AI
          <span style={{fontSize:"0.7rem",background:"rgba(110,243,197,.2)",padding:"4px 10px",borderRadius:"8px",marginLeft:"8px",color:"#6ef3c5",fontWeight:600}}>PREMIUM</span>
          {autoContinueActive&&(
            <span className="auto-continue-badge">
              <i data-lucide="loader" style={{width:"14px",height:"14px"}}></i>
              Resuming
            </span>
          )}
        </div>
        <div className="credit-section">
          <div className={`credit-display ${creditStatus}`}>
            <i data-lucide="zap"></i>
            <span>{credits} Credits</span>
          </div>
          <div className="credit-bar">
            <div className={`credit-fill ${creditStatus}`} style={{width:`${creditPercent}%`}}></div>
          </div>
          <button className="icon-btn" onClick={resetCredits} title="Reset Credits">
            <i data-lucide="refresh-cw"></i>
          </button>
        </div>
      </header>

      <div className="layout">
        <aside className="sidebar">
          <div className="sidebar-header">
            <div className="sidebar-title">
              <i data-lucide="folder"></i>
              Files ({files.length})
            </div>
            {files.length>0&&(
              <button className="icon-btn" onClick={clearAllFiles} title="Clear All">
                <i data-lucide="trash-2"></i>
              </button>
            )}
          </div>
          
          {files.length===0?(
            <div className="empty-state">
              <div><i data-lucide="inbox"></i></div>
              <div>No files yet</div>
              <div style={{fontSize:"0.8rem",marginTop:"8px"}}>Generate code to create files</div>
            </div>
          ):(
            <div className="file-list">
              {files.map(file=>(
                <div 
                  key={file.id} 
                  className={`file-item ${activeFileId===file.id?"active":""}`}
                  onClick={()=>selectFile(file.id)}
                >
                  <div className="file-info">
                    <div className="file-name" title={file.name}>{file.name}</div>
                    <div className="file-meta">{(file.size/1000).toFixed(1)}KB ‚Ä¢ {file.language}</div>
                  </div>
                  <div className="file-actions">
                    <button className="file-btn" onClick={(e)=>downloadFile(file.id,e)} title="Download">
                      <i data-lucide="download"></i>
                    </button>
                    <button className="file-btn" onClick={(e)=>deleteFile(file.id,e)} title="Delete">
                      <i data-lucide="trash-2"></i>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {files.length>1&&(
            <button className="secondary" onClick={downloadAllFiles} style={{width:"100%",marginTop:"12px",fontSize:"0.85rem",padding:"10px"}}>
              <i data-lucide="download-cloud"></i>
              <span>Download All</span>
            </button>
          )}
        </aside>

        <div className="main-content">
          <div className="main-panel">
            <div className="prompt-section">
              <div className="prompt-label">
                <i data-lucide="message-square"></i>
                What would you like to build?
                <span style={{marginLeft:"auto",fontSize:"0.75rem",background:"rgba(110,243,197,.15)",padding:"4px 10px",borderRadius:"6px",color:"#6ef3c5",display:"flex",alignItems:"center",gap:"4px"}}>
                  <i data-lucide="shield-check" style={{width:"14px",height:"14px"}}></i>
                  Resumable Engine (90s)
                </span>
              </div>
              <textarea 
                value={prompt} 
                onChange={e=>setPrompt(e.target.value)} 
                placeholder="Example: Create a responsive calculator with gradient design and keyboard support..."
                disabled={loading}
              />
              
              <div className="filename-section">
                <input 
                  type="text"
                  className="filename-input"
                  value={filename}
                  onChange={e=>setFilename(e.target.value)}
                  placeholder="Filename (auto-generated if empty)"
                  disabled={loading}
                />
                <button className="auto-name-btn" onClick={autoGenerateFilename} disabled={loading}>
                  <i data-lucide="wand-2" style={{width:"16px",height:"16px"}}></i> Auto
                </button>
              </div>
              
              {prompt&&(
                <div className="token-estimate">
                  <i data-lucide="info"></i>
                  <span>Estimated cost: <span className="token-cost">~{estimatedCost} credits</span></span>
                  <span>‚Ä¢</span>
                  <span>Remaining after: <span className="token-cost">{Math.max(credits-estimatedCost,0)} credits</span></span>
                  <span>‚Ä¢</span>
                  <span style={{color:"#6ef3c5"}}>‚ú® Quality assured</span>
                </div>
              )}
            </div>

            <div className="actions">
              <button className="primary" onClick={generate} disabled={loading||!prompt.trim()}>
                <i data-lucide={loading?"loader":"sparkles"}></i>
                <span>{loading?"Generating...":"Generate Code"}</span>
              </button>
              <button className="secondary" onClick={copyCode} disabled={!activeFile}>
                <i data-lucide="copy"></i>
                <span>Copy</span>
              </button>
              {activeFile&&(
                <button className="secondary" onClick={continueActiveFile} disabled={loading}>
                  <i data-lucide="play-circle"></i>
                  <span>Continue Code</span>
                </button>
              )}
            </div>

            <div className={`progress-container ${loading?"active":""}`}>
              <div className="progress-bar">
                <div className="progress-fill" style={{width:`${progress}%`}}></div>
              </div>
              <div className="progress-text">
                {autoContinueActive?"Resuming with fresh SDK...":"Generating your code..."} {progress}%
              </div>
            </div>
          </div>

          <div className="editor-container">
            <div className="editor-header">
              <div className="editor-title">
                <i data-lucide="code"></i>
                {activeFile?activeFile.name:"Editor"}
              </div>
              <div className="editor-actions">
                {activeFile&&(
                  <div style={{fontSize:"0.9rem",color:"#94a3b8",marginRight:"12px"}}>
                    Language: <span style={{color:"#6ef3c5",fontWeight:700}}>{activeFile.language}</span>
                  </div>
                )}
              </div>
            </div>
            <div id="editor"></div>
            <div className="stats">
              <div className="stat-item">
                <i data-lucide="files"></i>
                <span>Total Files: <span className="stat-value">{files.length}</span></span>
              </div>
              {activeFile&&(
                <>
                  <div className="stat-item">
                    <i data-lucide="file-text"></i>
                    <span>Characters: <span className="stat-value">{activeFile.size.toLocaleString()}</span></span>
                  </div>
                  <div className="stat-item">
                    <i data-lucide="layers"></i>
                    <span>Lines: <span className="stat-value">{activeFile.content.split('\n').length}</span></span>
                  </div>
                </>
              )}
              <div className="stat-item">
                <i data-lucide="zap"></i>
                <span>Credits Used: <span className="stat-value">{maxCredits-credits}</span></span>
              </div>
              <div className="stat-item" style={{color:"#6ef3c5"}}>
                <i data-lucide="shield-check"></i>
                <span>Quality: <span className="stat-value">Premium</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {toast&&(
        <div className={`toast ${toast.type}`}>
          <i data-lucide={
            toast.type==="success"?"check-circle":
            toast.type==="error"?"x-circle":
            toast.type==="warning"?"alert-triangle":
            "info"
          }></i>
          <span>{toast.msg}</span>
        </div>
      )}

      {modal&&(
        <div className="modal-overlay" onClick={closeModal}>
          <div className={`modal ${modal.type}`} onClick={e=>e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-icon">
                <i data-lucide={modal.type==="warning"?"alert-triangle":"alert-circle"}></i>
              </div>
              <div className="modal-title">{modal.title}</div>
            </div>
            <div className="modal-body">{modal.body}</div>
            <div className="modal-actions">
              {modal.onConfirm&&(
                <button className="primary" onClick={modal.onConfirm}>
                  <i data-lucide="check"></i>
                  <span>Continue</span>
                </button>
              )}
              <button className="secondary" onClick={closeModal}>
                <i data-lucide="x"></i>
                <span>{modal.onConfirm?"Cancel":"Close"}</span>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
